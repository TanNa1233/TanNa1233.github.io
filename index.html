<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบขยะ + ผู้ใช้ (Firebase)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; background: #f0f0f0; }
    input, button { padding: 10px; width: 100%; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: teal; color: white; cursor: pointer; }
    button:hover { background: #007b7b; }
    #main-section, #dashboard { display: none; margin-top: 20px; }
    .user-entry { background: white; padding: 10px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<h1>ระบบติดตามการทิ้งขยะ</h1>

<div id="auth-section">
  <input type="email" id="email" placeholder="อีเมล" />
  <input type="password" id="password" placeholder="รหัสผ่าน" />
  <button onclick="register()">สมัครสมาชิก</button>
  <button onclick="login()">เข้าสู่ระบบ</button>
</div>

<div id="main-section">
  <p>ยินดีต้อนรับ, <strong id="userDisplay"></strong>!</p>
  <input type="number" id="trashCount" placeholder="วันนี้ทิ้งขยะไปกี่ชิ้น?" />
  <button onclick="submitTrash()">บันทึกขยะ</button>
  <button onclick="showData()">ดูข้อมูลทั้งหมด</button>
  <button onclick="logout()">ออกจากระบบ</button>
</div>

<div id="dashboard">
  <h3>ข้อมูลผู้ใช้ทั้งหมด:</h3>
  <div id="userDataList"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ใส่ config ของ Firebase โปรเจกต์คุณตรงนี้
 const firebaseConfig = {
  apiKey: "AIzaSyBGuJzWWSrUZuTu0yOOyr6no5BvMn0TTCI",
  authDomain: "tan12-39f3c.firebaseapp.com",
  databaseURL: "https://tan12-39f3c-default-rtdb.firebaseio.com",
  projectId: "tan12-39f3c",
  storageBucket: "tan12-39f3c.firebasestorage.app",
  messagingSenderId: "221016907978",
  appId: "1:221016907978:web:c65942c751852b32ff5433",
  measurementId: "G-SJLXXDF97C"
};

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const adminEmails = ["kawinhinmumu@gmail.com", "40085@streesp.ac.th"];
  let currentUser = null;

  function register() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) {
      alert("กรุณากรอกอีเมลและรหัสผ่าน");
      return;
    }
    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        alert("สมัครสมาชิกเรียบร้อย ✅ กรุณาล็อกอิน");
      })
      .catch(error => alert(error.message));
  }

  function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) {
      alert("กรุณากรอกอีเมลและรหัสผ่าน");
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        currentUser = userCredential.user;
        document.getElementById('auth-section').style.display = "none";
        document.getElementById('main-section').style.display = "block";
        document.getElementById('userDisplay').innerText = currentUser.email;
      })
      .catch(error => alert(error.message));
  }

  function logout() {
    auth.signOut().then(() => {
      currentUser = null;
      document.getElementById('auth-section').style.display = "block";
      document.getElementById('main-section').style.display = "none";
      document.getElementById('dashboard').style.display = "none";
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      document.getElementById('trashCount').value = '';
    });
  }

  function submitTrash() {
    const count = parseInt(document.getElementById('trashCount').value);
    if (isNaN(count) || count < 0) {
      alert("กรุณากรอกจำนวนขยะที่ถูกต้อง");
      return;
    }
    const userRef = db.ref('users/' + currentUser.uid);
    userRef.get().then(snapshot => {
      const data = snapshot.val() || { trash: 0, score: 0, email: currentUser.email };
      data.trash += count;
      userRef.set(data).then(() => {
        alert("บันทึกข้อมูลเรียบร้อย ✅");
        document.getElementById('trashCount').value = '';
      });
    });
  }

  function showData() {
    db.ref('users').get().then(snapshot => {
      const users = snapshot.val() || {};
      const container = document.getElementById('userDataList');
      container.innerHTML = '';

      Object.entries(users).forEach(([uid, user]) => {
        const canAddScore = adminEmails.includes(user.email);
        const div = document.createElement('div');
        div.className = 'user-entry';
        div.innerHTML = 
          <strong>${user.email || 'ไม่ทราบอีเมล'}</strong><br>
          ขยะสะสม: ${user.trash || 0} ชิ้น<br>
          คะแนน: ${user.score || 0}<br>
          ${canAddScore ? <input type="number" placeholder="เพิ่มคะแนน" onchange="addScore('${uid}', this.value)"> : ''}
        ;
        container.appendChild(div);
      });

      document.getElementById('dashboard').style.display = 'block';
    });
  }

  function addScore(uid, value) {
    const scoreToAdd = parseInt(value);
    if (isNaN(scoreToAdd)) return;

    // เช็คสิทธิ์ admin ก่อนเพิ่มคะแนน
    if (!currentUser) return alert("กรุณาล็อกอิน");

    if (!adminEmails.includes(currentUser.email)) {
      alert("คุณไม่มีสิทธิ์เพิ่มคะแนน");
      showData();
      return;
    }

    const userRef = db.ref('users/' + uid);
    userRef.get().then(snapshot => {
      const data = snapshot.val() || { trash: 0, score: 0 };
      data.score += scoreToAdd;
      userRef.set(data).then(() => {
        showData();
      });
    });
  }
</script>

</body>
</html> 
